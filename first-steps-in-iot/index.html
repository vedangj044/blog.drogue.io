<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" href="https://blog.drogue.io/main.css">

    <title>First Steps in IoT &mdash; Drogue IoT</title>

    
    <link rel="alternate" type="application/rss+xml" title="RSS" href="https://blog.drogue.io/rss.xml">
    

    
    <style>
        .hero-body {
            padding: 0;
        }
        .header-image {
            width: 100%;
            max-width: unset;

            height: auto;
            min-height: 32px;
            max-height: 33vh !important;

            object-fit: contain;
            object-position: left center;
            background-color: #8cc73f;
        }
    </style>
    <link rel="icon" type="image/svg+xml" href="https://blog.drogue.io/favicon.svg">
    

    <meta name="description" content="Welcome to the Drogue IoT blog. This is where I intend to document 
my progress through discovering how to build enterprise-grade IoT device
systems using Rust and ARM Cortex-M MCUs.
">


<meta name="twitter:card" content="summary">
<meta name="twitter:site" content="@DrogueIoT" />
<meta name="twitter:title" content="First Steps in IoT" />
<meta name="twitter:description" content="Welcome to the Drogue IoT blog. This is where I intend to document 
my progress through discovering how to build enterprise-grade IoT device
systems using Rust and ARM Cortex-M MCUs.
">
<meta name="twitter:image" content='https://blog.drogue.io/default_social_image.png'>


<meta property="og:type" content="article" />
<meta property="og:site_name" content="Drogue IoT">
<meta property="og:title" content="First Steps in IoT">
<meta property="og:url" content="https://blog.drogue.io/first-steps-in-iot">
<meta property="og:description" content="Welcome to the Drogue IoT blog. This is where I intend to document 
my progress through discovering how to build enterprise-grade IoT device
systems using Rust and ARM Cortex-M MCUs.
">
<meta property="og:image" content='https://blog.drogue.io/default_social_image.png'>


    <script async src="https://www.googletagmanager.com/gtag/js?id=G-QVBDYPJX0S"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());

        gtag('config', 'G-QVBDYPJX0S', { 'anonymize_ip': true });
    </script>
  </head>

<body>

<section class="hero pb-5">
  <div class="hero-body">
    <a href="https://blog.drogue.io">
      <img class="header-image" src="https://blog.drogue.io/header.svg" alt="Header image">
    </a>
  </div>
</section>

<section class="section">
  

<div class="container is-fluid">
  <div class="columns">
    <div class="column is-offset-one-quarter-fullhd is-half-fullhd is-two-thirds-tablet is-three-quarters-desktop is-full">
      <article itemscope itemtype="http://schema.org/BlogPosting">

        <section class="content">
          <h1 class="title is-size-2" itemprop="name headline">First Steps in IoT</h1>
          <div class="subtitle has-text-grey">
          

<div class="post-info">

    <div class="post-info-item">
        <span>7 minute read</span>
        <meta itemprop="wordCount" content="1220">
    </div>

    
        <div class="post-info-item">
            <span itemprop="datePublished" content='2020-08-03'> 3 August 2020</span>
        </div>
    

    

    
        <div class="post-info-item">
        <span>by 

<span itemprop="author" itemscope itemtype="http://schema.org/Person">
<span itemprop="name">Bob McWhirter</span>
</span>

</span>
        </div>
    

    <div class="post-info-item">
        <span><a href="&#x2F;first-steps-in-iot&#x2F;#comments">comments</a></span>
    </div>

    

</div>


          </div>
        </section>

        <hr>

        <section class="content post-content" itemprop="articleBody">
          <p>Welcome to the <em>Drogue IoT</em> blog. This is where I intend to document 
my progress through discovering how to build enterprise-grade IoT device
systems using Rust and ARM Cortex-M MCUs.</p>
<span id="continue-reading"></span><h1 id="introduction">Introduction</h1>
<p>I'm coming from a background of enterprise Java development, where things
can easily be rebooted, debugged, and 16gb of heap can easily be garbage-collected.</p>
<p>I also have virtually no experience with hardware and electronics.</p>
<p>As you can imagine, this journey will be full of frustrations and missteps.</p>
<p>Let's begin!</p>
<h2 id="status-quo">Status Quo</h2>
<p>The first project I'm working on, mostly as a way to learn new things, involves
replacing a project I've already built before once: <em>Mr Weathery</em>.  <em>Mr Weathery</em>
is built using the Particle.io cloud and Arduino-like devices, plus a Raspberry Pi
3B+ sitting in corner. </p>
<p>The Pi runs a node.js application that periodically polls the <a href="https://www.netatmo.com/en-us/weather">Netatmo weather</a> 
cloud for data from my local weather sensors. It'd also poll the DarkSky APIs for weather
forecasts. It would then put all of this information on the Particle.io message bus.</p>
<p>The first Particle.io device has both WiFi and BLE on-board, and running stock firmware
it simple acts as a bridge from the IP-based Particle cloud to my main Particle.io board that
only speaks BLE, which consumes all of the abovementioned data.</p>
<p>The BLE-only board drives an e-paper display to handily show the current and forecast
weather conditions.</p>
<p><img src="/images/weathery-bare.png" alt="Mr Weathery" /></p>
<p>That's 3 boards, 2 clouds, and a 1 third-party API involved to simply tell me it's raining,
or will be raining tomorrow. Given the machinations around some of these vendors, 
I realized I should reformulate how <em>Mr Weathery</em> works.</p>
<p>Plus, given it's a known problem domain with at least one known solution to me,
I can concentrate on the implementation, not on the specification and design.</p>
<h2 id="the-new-plan">The New Plan</h2>
<p>When originally designed, <em>Mr Weathery</em> was intended to be battery-powered, hence the
usage of the BLE board.  In reality, he's always plugged into the power mains, so the
low-power requirement is less important. </p>
<p>If the display can also have consistent power, he can also perform all of the HTTP-over-WiFi 
dancing directly. That would allow me to remove both the Raspberry Pi and the 
WiFi-to-BLE bridge to produce a standalone device.</p>
<p>Instead of programming an Arduino-like device using C, I'm moving to an 
<a href="https://www.st.com/en/microcontrollers-microprocessors/stm32-32-bit-arm-cortex-mcus.html">STM32 ARM Cortex-M</a>
chip to power it, using Rust. This is quite the change for me. So far I quite enjoy Rust,
and the Cortex-M is a nice 32bit processor with more power than many Arduino-like boards.</p>
<p>The downside, thus far, is that the STM32s don't have WiFi on-board. While I could adapter boards
or shields to a dev-kit, I'd ultimately like to fabricate a custom board around the MCU and
use a simpler/smaller pre-certified WiFi module.</p>
<p>Given I have a bag of Espressif <a href="https://en.wikipedia.org/wiki/ESP8266">ESP8266 modules</a> handy, 
I'm approaching it as my WiFi adapter.</p>
<p><img src="/images/f401-esp8266.jpg" alt="STM32F401 and ESP8266" /></p>
<p>For the time-being, I'm using an <a href="https://www.digikey.com/product-detail/en/stmicroelectronics/NUCLEO-F401RE/497-14360-ND/4695525">STM32F401RE development board</a> 
running at 84mhz for building the software. It has the benefit of having a USB port with ST-Link on-board
for easily flashing and debugging the code.</p>
<h2 id="because-nothing-is-easy">Because Nothing is Easy</h2>
<p>Of course, nothing ever is easy.</p>
<p>The ESP8266 is available through the <a href="https://en.wikipedia.org/wiki/Universal_synchronous_and_asynchronous_receiver-transmitter">USART</a> 
on the STM32. It's fairly simple to wire
up, and it communicates with Hayes AT commands to enumerate available WiFi access points,
join a network, open sockets and communicate.  The AT commands are pretty well documented,
but I discovered my bag of ESP8266 were flashed with firmware in... 2016.  And they don't
match the current capabilities documented by Espressif. </p>
<p>The ESP8266 runs an Xtensa chip, which is not currently supported by embedded Rust on the 
mainline, and frankly, writing software directly for the ESP8266 would be an effort in 
Yak-shaving, so I simply need to update its stock firmware to a newer version.</p>
<p>While people speak of &quot;ESP8266&quot; as a thing, it's actually many things, with varying amount 
of memory on-board. Mine has 1mb. Espressif has had varying degrees of diligence in producing
firmware versions that fit the various sizes of ESPs. Thankfully, a repository exists with
a slightly improved build/flash situation to target whatever size ESP you might have:</p>
<p><a href="https://github.com/loboris/ESP8266_AT_LoBo/">ESP8266_AT_LoBo GitHub Repository</a></p>
<p>This repository is definitely Linux-centric, but a few edits to the various scripts, and
it runs will enough on OSX to work.</p>
<p>To flash an ESP8266, you need a serial port on your machine, which is provided using
an <a href="https://www.amazon.com/Adapter-Serial-Converter-Development-Projects/dp/B075N82CDL">FTDI adapter</a>. 
The FTDI converts a USB port into a few pins of serial port, and also 
provides 3.3v or 5v of power. There are many warnings on the interwebs that the current 
they provide is not enough to actually power an ESP during flash or usage.</p>
<p>To overcome this potential problem, I'm powering the ESP through a breadboard 3.3v 
power supply.</p>
<p><img src="/images/esp-flash-circuit.jpeg" alt="ESP flashing circuit" /></p>
<h3 id="stay-grounded">Stay Grounded</h3>
<p>While attempting to use the ESP through a serial terminal (because it should operate
like your old USRobotics 14.4k Dual Standard modem you used to connect to FidoNet...)
I was finding a ton of noise, and it didn't work. </p>
<p><strong>Lesson #1: All grounds must be tied together.</strong></p>
<p>Even if you're not using the power from the FTDI, its ground pin needs to be connected
to the same ground pin the ESP uses. Serial USART works in relation to a common reference 
voltage (GND), and if two devices have different concepts of ground, it's just not going to work.</p>
<h3 id="don-t-trust-your-tools">Don't trust your tools</h3>
<p>Using the flashing scripts from LoBo, everything appeared successful, yet my device
kept coming up non-funcitonal. Turns out there are several <em>flash modes</em> for ESPs, and
the <a href="https://github.com/espressif/esptool"><code>esptool.py</code></a> doesn't actually really verify if flashing was successful in terms of
being <em>actually successful</em>. Rather, it just seems to think it successfully sent bytes
down the wire.</p>
<p><strong>Lesson #2: Try all variants until you find the one that works.</strong></p>
<p>In my case, for my ESP8266, I had to use a flash-mode of <code>dout</code>. </p>
<h2 id="back-to-making-progress">Back to making progress</h2>
<pre style="background-color:#2b303b;">
<code><span style="color:#c0c5ce;">murray:esp8266-tcp bob$ miniterm.py /dev/tty.usbserial-AB0JSKDU 115200
--- Miniterm on /dev/tty.usbserial-AB0JSKDU  115200,8,N,1 ---
--- Quit: Ctrl+] | Menu: Ctrl+T | Help: Ctrl+T followed by Ctrl+H ---
r␘␂␀l��r�␀�c␂�n�␄␘�␌␘�␌␜��␜p�|���␀�8␂��ǒ��␜p␌␘␌�nn�␂�;�n����␌␛�␌b�#l`␛$`␛␄nn���␀␌␜���l␜�␌␟�␌␜�␌b�␄n��n�䎀l��␌b�ľ~�n�␃����␀l`␛��␒�#�n�␄�r␘␂␎␂nr���;␂��␌?␐��;�␂p�n��܀␌␜�r�␜��␜b��␌␜�␌b�␄n��n�$␏�␜p␌␘��nn�␃��␌␘r␘␂�␒�#�n�␄␏r␘␂␎␂nr���;␂��␌?␐��␂␎r�ےn�␄���߬�
==============================
LoBo ESP8266 Bootloader v1.2.0
==============================
   Flash map: 2, 1MB (512+512)
  Flash mode: DOUT, [ESP8285]
Reset reason: POWER_ON

Loading configured firmware (0)
  Address: 001000
Starting firmware 0, map 2 from 001000...


ready

</span></code></pre>
<p>I finally got the ESP8266 updated with a modern-ish variant of the firmware and
can return to writing Rust for the STM32F401RE in order to actually get that
board onto the network.</p>
<p>More on that to come.</p>

        </section>

        <section id="comments" class="content">

          <hr>

          <h2>Comments</h2>

          <div id='discourse-comments'></div>

          <script type="text/javascript">
              DiscourseEmbed = { discourseUrl: 'https://discourse.drogue.io/',
                  discourseEmbedUrl: 'https://blog.drogue.io/first-steps-in-iot' };

              (function() {
                  var d = document.createElement('script'); d.type = 'text/javascript'; d.async = true;
                  d.src = DiscourseEmbed.discourseUrl + 'javascripts/embed.js';
                  (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(d);
              })();
          </script>
        </section>

      </article>

    </div>

    <aside class="column is-hidden-mobile is-one-third-tablet is-one-quarter-desktop mx-5">
      <div class="box is-sticky">
        <div class="title is-size-3"><a href="#">Table of contents</a></div>
        <nav class="menu">
          <ul class="menu-list">
            
            <li>
              <a data-for="introduction" href="https://blog.drogue.io/first-steps-in-iot/#introduction">Introduction</a>
              
              <ul class="menu-list">
                
                <li>
                  <a data-for="status-quo" href="https://blog.drogue.io/first-steps-in-iot/#status-quo">Status Quo</a>
                </li>
                
                <li>
                  <a data-for="the-new-plan" href="https://blog.drogue.io/first-steps-in-iot/#the-new-plan">The New Plan</a>
                </li>
                
                <li>
                  <a data-for="because-nothing-is-easy" href="https://blog.drogue.io/first-steps-in-iot/#because-nothing-is-easy">Because Nothing is Easy</a>
                </li>
                
                <li>
                  <a data-for="back-to-making-progress" href="https://blog.drogue.io/first-steps-in-iot/#back-to-making-progress">Back to making progress</a>
                </li>
                
              </ul>
              
            </li>
            
          </ul>
        </nav>
      </div>
    </aside>

  </div>

</div>


</section>

<footer class="footer">
  <div class="content has-text-centered">
    <p>
      <strong>Drogue IoT</strong>
  </div>
</footer>

<script src="https://blog.drogue.io/default.js"></script>

</body>

</html>
